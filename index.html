<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Douyin ÊäñÈü≥ | Estudio Etno-Ecol√≥gico de Nichos 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #fff; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 30px 20px; border-bottom: 1px solid #333; margin-bottom: 30px; }
        header h1 { font-size: 1.8rem; margin-bottom: 10px; color: #00ffcc; }
        header p { color: #888; font-size: 0.95rem; }
        
        .top3-panel { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 25px; border-radius: 15px; margin: 25px 0; border: 1px solid #00ffcc; }
        .top3-panel h3 { text-align: center; color: #00ffcc; margin-bottom: 20px; font-size: 1.3rem; }
        .top3-item { display: flex; align-items: center; padding: 12px 20px; margin: 10px 0; background: rgba(0,255,204,0.08); border-radius: 10px; border-left: 3px solid #00ffcc; }
        .medal { font-size: 1.8rem; margin-right: 15px; width: 40px; text-align: center; }
        .top3-info { flex: 1; }
        .top3-name { font-weight: bold; color: #fff; font-size: 1.1rem; }
        .top3-desc { font-size: 0.85rem; color: #888; margin-top: 3px; }
        .percentage { font-size: 1.5rem; font-weight: bold; color: #ffaa00; }
        .top3-note { text-align: center; font-size: 0.8rem; color: #666; margin-top: 15px; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 25px 0; }
        .stat-card { background: #1a1a1a; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        .stat-card .number { font-size: 1.8rem; font-weight: bold; color: #00ffcc; }
        .stat-card .label { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .nav { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; justify-content: center; }
        .nav-item { padding: 10px 20px; background: #1a1a1a; border: 1px solid #333; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
        .nav-item:hover, .nav-item.active { background: #00ffcc; color: #000; border-color: #00ffcc; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card { background: #1a1a1a; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s; border: 1px solid #333; }
        .card:hover { transform: translateY(-5px); border-color: #00ffcc; }
        .card-img { width: 100%; height: 220px; object-fit: cover; display: block; }
        .tabla-container { overflow-x: auto; background: #1a1a1a; border-radius: 10px; padding: 15px; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #333; font-size: 0.9rem; }
        th { color: #00ffcc; font-weight: 600; position: sticky; top: 0; background: #1a1a1a; }
        tr:hover { background: #252525; }
        #chinaMap { width: 100%; height: 600px; background: #1a1a1a; border-radius: 10px; border: 1px solid #333; }
        #barChart { width: 100%; height: 500px; background: #1a1a1a; border-radius: 10px; border: 1px solid #333; margin-top: 20px; }
        .metodo { background: #1a1a1a; padding: 25px; border-radius: 10px; border: 1px solid #333; line-height: 1.8; }
        .metodo h3 { color: #00ffcc; margin-bottom: 15px; }
        .metodo ul { margin-left: 20px; margin-bottom: 15px; }
        footer { text-align: center; padding: 30px 20px; margin-top: 40px; border-top: 1px solid #333; color: #888; font-size: 0.9rem; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; }
        #modal.active { display: flex; }
        #modal-img { max-width: 90%; max-height: 90%; border-radius: 10px; border: 2px solid #00ffcc; }
        .modal-close { position: absolute; top: 20px; right: 30px; font-size: 2rem; color: #fff; cursor: pointer; }
        .modal-close:hover { color: #00ffcc; }
        @media (max-width: 768px) { .galeria { grid-template-columns: repeat(2, 1fr); } .card-img { height: 180px; } .stats { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Douyin ÊäñÈü≥</h1>
            <p>ESTUDIO ETNO-ECOL√ìGICO DE NICHOS EN DOUYIN 2026</p>
            <p style="color:#666;margin-top:5px">Juan Carlos Delgado</p>
        </header>

        <div class="top3-panel">
            <h3>üèÜ TOP 3 Tem√°ticas - Influencers Famosas (+1M seguidores)</h3>
            <div id="top3-tematicas"><p style="text-align:center;color:#888">Cargando...</p></div>
            <p class="top3-note">* Famosas = +1M seguidores en Douyin</p>
        </div>

        <div class="stats">
            <div class="stat-card"><div class="number" id="total-fichas">0</div><div class="label">Creadoras</div></div>
            <div class="stat-card"><div class="number" id="max-seguidores">0</div><div class="label">M√°x seguidores</div></div>
            <div class="stat-card"><div class="number" id="max-ratio">0</div><div class="label">M√°x ratio</div></div>
            <div class="stat-card"><div class="number" id="total-regiones">0</div><div class="label">Regiones</div></div>
        </div>

        <div class="nav">
            <div class="nav-item active" onclick="showSection('lista')">üìã LISTA</div>
            <div class="nav-item" onclick="showSection('galeria')">üñºÔ∏è GALER√çA</div>
            <div class="nav-item" onclick="showSection('ranking')">üìä RANKING</div>
            <div class="nav-item" onclick="showSection('mapa')">üó∫Ô∏è MAPA</div>
            <div class="nav-item" onclick="showSection('metodo')">üìö M√âTODO</div>
        </div>

        <section id="lista" class="section active">
            <h2 style="margin-bottom:15px;color:#00ffcc">üìã LISTA MAESTRA</h2>
            <p style="color:#888;margin-bottom:20px">"Cada creadora es un dato en el ecosistema Douyin"</p>
            <div class="tabla-container">
                <table>
                    <thead><tr><th>Nombre</th><th>Seguidores</th><th>Likes</th><th>Ratio</th><th>Origen</th><th>Nicho</th></tr></thead>
                    <tbody id="tabla-body"></tbody>
                </table>
            </div>
        </section>

        <section id="galeria" class="section">
            <h2 style="margin-bottom:20px;color:#00ffcc">üñºÔ∏è GALER√çA</h2>
            <div id="galeria-cards" class="galeria"></div>
        </section>

        <section id="ranking" class="section">
            <h2 style="margin-bottom:20px;color:#00ffcc">üìä RANKING</h2>
            <div id="barChart"></div>
        </section>

        <section id="mapa" class="section">
            <h2 style="margin-bottom:20px;color:#00ffcc">üó∫Ô∏è MAPA DE CHINA</h2>
            <div id="chinaMap"></div>
        </section>

        <section id="metodo" class="section">
            <h2 style="margin-bottom:20px;color:#00ffcc">üìö M√âTODO ETNO-ECOL√ìGICO</h2>
            <div class="metodo">
                <h3>üîç Enfoque</h3>
                <ul><li>Observaci√≥n participante en Douyin (2024-2026)</li><li>Mapeo de nichos por regi√≥n, contenido y engagement</li><li>An√°lisis cualitativo + m√©tricas cuantitativas</li></ul>
                <h3>üìä M√©tricas clave</h3>
                <ul><li><strong>Ratio:</strong> Likes √∑ Seguidores (engagement relativo)</li><li><strong>Origen:</strong> Provincia/ciudad de la creadora</li><li><strong>Nicho:</strong> Categor√≠a principal de contenido</li></ul>
                <h3>üåê Visualizaci√≥n</h3>
                <ul><li>Mapa interactivo con ECharts</li><li>Ranking de engagement por creadora</li><li>Galer√≠a visual con filtros por nicho</li></ul>
            </div>
        </section>

        <footer>
            <p>Estudio Etno-Ecol√≥gico de Nichos en Douyin 2026</p>
            <p style="margin-top:10px">Juan Carlos Delgado ¬∑ Marzo 2026</p>
            <p id="footer-fichas" style="margin-top:10px;color:#666">0 creadoras</p>
        </footer>
    </div>

    <div id="modal" onclick="cerrarModal()">
        <span class="modal-close">&times;</span>
        <img id="modal-img" src="" alt="Vista ampliada">
    </div>

    <script src="fichas.js?v=2026032201"></script>
    <script>
        let cardsVisibles = 12;
        const cardsPorCarga = 12;

        // ‚úÖ FUNCI√ìN PARA OBTENER PROPIEDADES (maneja espacios y may√∫sculas)
        function getVal(obj, key) {
            if (!obj) return '';
            const keys = [key, key + ' ', key.toLowerCase(), key.toLowerCase() + ' ', 
                         key.charAt(0).toUpperCase() + key.slice(1), 
                         key.charAt(0).toUpperCase() + key.slice(1) + ' '];
            for (let k of keys) {
                if (obj[k] !== undefined && obj[k] !== null) return obj[k];
            }
            return '';
        }

        function getNum(obj, key) {
            const val = getVal(obj, key);
            return typeof val === 'number' ? val : parseFloat(val) || 0;
        }

        // ‚úÖ TOP 3 TEM√ÅTICAS
        function calcularTop3Tematicas() {
            const datos = window.fichas || [];
            if (!datos || datos.length === 0) return;
            
            const famosas = datos.filter(f => getNum(f, 'seguidores') >= 1);
            if (famosas.length === 0) {
                document.getElementById('top3-tematicas').innerHTML = '<p style="text-align:center;color:#888">üìä Sin influencers famosas (+1M)</p>';
                return;
            }
            
            const conteo = {};
            famosas.forEach(f => {
                const t = (getVal(f, 'tematica_principal') || 'otras').toLowerCase();
                if (!conteo[t]) conteo[t] = 0;
                conteo[t]++;
            });
            
            const total = famosas.length;
            const top3 = Object.entries(conteo)
                .map(([tematica, count]) => ({ tematica, count, porcentaje: Math.round((count / total) * 100) }))
                .sort((a, b) => b.porcentaje - a.porcentaje)
                .slice(0, 3);
            
            const emojis = { danza: 'üíÉ', tradicional: 'üé≠', lifestyle: 'üëó', deportes: 'üèÉ', musica: 'üéµ', arte: 'üé®', cocina: 'üç≥', belleza: 'üíÑ', otras: '‚≠ê' };
            const medallas = ['ü•á', 'ü•à', 'ü•â'];
            
            let html = '';
            top3.forEach((item, i) => {
                const emoji = emojis[item.tematica] || '‚≠ê';
                const nombre = item.tematica.charAt(0).toUpperCase() + item.tematica.slice(1);
                html += `<div class="top3-item"><div class="medal">${medallas[i]}</div><div class="top3-info"><div class="top3-name">${emoji} ${nombre}</div><div class="top3-desc">${item.count} de ${total} influencers famosas</div></div><div class="percentage">${item.porcentaje}%</div></div>`;
            });
            
            document.getElementById('top3-tematicas').innerHTML = html;
        }

        function actualizarPagina() {
            const datos = window.fichas || [];
            if (!datos || datos.length === 0) return;
            
            const porSeguidores = [...datos].sort((a, b) => getNum(b, 'seguidores') - getNum(a, 'seguidores'));
            
            document.getElementById('total-fichas').textContent = datos.length;
            document.getElementById('max-seguidores').textContent = getNum(porSeguidores[0], 'seguidores').toFixed(2) + 'M';
            document.getElementById('max-ratio').textContent = Math.max(...datos.map(f => getNum(f, 'ratio'))).toFixed(2);
            const regiones = new Set(datos.map(f => (getVal(f, 'provincia') || getVal(f, 'origen') || '').split(',')[0].trim()));
            document.getElementById('total-regiones').textContent = regiones.size;
            document.getElementById('footer-fichas').textContent = datos.length + ' creadoras ¬∑ 30,500+ comunidad';
            
            const tbody = document.getElementById('tabla-body');
            if (tbody) {
                tbody.innerHTML = '';
                porSeguidores.forEach(f => {
                    tbody.innerHTML += `<tr><td>${getVal(f, 'nombre')} (${getVal(f, 'pinyin')})</td><td>${getNum(f, 'seguidores').toFixed(3)}M</td><td>${getNum(f, 'like')}M</td><td>${getNum(f, 'ratio').toFixed(2)}</td><td>${getVal(f, 'origen')}</td><td>${getVal(f, 'nicho')}</td></tr>`;
                });
            }
            
            const galeria = document.getElementById('galeria-cards');
            if (galeria) {
                galeria.innerHTML = '';
                datos.slice(0, cardsVisibles).forEach(f => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.onclick = (e) => { e.stopPropagation(); abrirModal(getVal(f, 'archivo')); };
                    card.innerHTML = `<img src="https://raw.githubusercontent.com/dicarlophotoart-blip/estudio-douyin-2026/main/cards/${encodeURIComponent(getVal(f, 'archivo'))}" class="card-img" loading="lazy" onerror="this.style.display='none'">`;
                    galeria.appendChild(card);
                });
                if (cardsVisibles < datos.length) {
                    const btnMas = document.createElement('div');
                    btnMas.style.cssText = 'grid-column: 1/-1; text-align: center; margin: 30px 0;';
                    btnMas.innerHTML = `<button class="nav-item" onclick="cargarMasCards()" style="padding:12px 30px;font-size:16px;cursor:pointer;">üì∑ Ver m√°s (${datos.length - cardsVisibles})</button>`;
                    galeria.appendChild(btnMas);
                }
            }
            
            calcularTop3Tematicas();
        }

        function cargarMasCards() {
            cardsVisibles += cardsPorCarga;
            actualizarPagina();
            document.getElementById('galeria').scrollIntoView({ behavior: 'smooth' });
        }

        function generarMapa() {
            const mapDiv = document.getElementById('chinaMap');
            if (!mapDiv) return;
            let chart = echarts.getInstanceByDom(mapDiv);
            if (chart) echarts.dispose(chart);
            chart = echarts.init(mapDiv);
            
            const datos = window.fichas || [];
            const conCoord = datos.filter(f => {
                const x = getNum(f, 'coord_x') || getNum(f, 'Coord x');
                const y = getNum(f, 'coord_y') || getNum(f, 'Coord y');
                return x && y;
            });
            
            const grupos = {};
            conCoord.forEach(f => {
                const x = getNum(f, 'coord_x') || getNum(f, 'Coord x');
                const y = getNum(f, 'coord_y') || getNum(f, 'Coord y');
                const key = x + ',' + y;
                if (!grupos[key]) grupos[key] = { coord: [x, y], creadoras: [], total: 0 };
                grupos[key].creadoras.push(f);
                grupos[key].total += getNum(f, 'seguidores');
            });
            
            const puntosData = Object.values(grupos).map(g => ({
                name: g.creadoras.length > 1 ? g.creadoras.length + ' creadoras' : getVal(g.creadoras[0], 'nombre'),
                value: [...g.coord, g.creadoras.length],
                cantidad: g.creadoras.length,
                creadoras: g.creadoras.map(c => ({ nombre: getVal(c, 'nombre'), pinyin: getVal(c, 'pinyin'), origen: getVal(c, 'origen'), nicho: getVal(c, 'nicho'), seguidores: getNum(c, 'seguidores'), ratio: getNum(c, 'ratio') })),
                totalSeguidores: g.total
            }));
            
            const option = {
                backgroundColor: '#1a1a1a',
                title: { text: 'Distribuci√≥n de ' + conCoord.length + ' creadoras', left: 'center', textStyle: { color: '#00ffcc', fontSize: 16 } },
                tooltip: { 
                    trigger: 'item', 
                    formatter: (p) => { 
                        const d = p.data; 
                        if (!d || !d.creadoras) return ''; 
                        let h = '<b>' + d.cantidad + ' creadora' + (d.cantidad > 1 ? 's' : '') + '</b><br/>üìç Total: ' + d.totalSeguidores.toFixed(3) + 'M<br/><br/>'; 
                        d.creadoras.forEach((c, i) => { 
                            h += (i+1) + '. <b>' + c.nombre + '</b> (' + c.pinyin + ')<br/>   üìç ' + c.origen + '<br/>   üé® ' + c.nicho + '<br/>   üë• ' + c.seguidores.toFixed(3) + 'M ¬∑ üìà ' + c.ratio.toFixed(2) + '<br/><br/>'; 
                        }); 
                        return h.slice(0, -4); 
                    } 
                },
                geo: { 
                    map: 'china', roam: true, zoom: 1.2, 
                    label: { show: true, color: '#fff', fontSize: 9 }, 
                    itemStyle: { areaColor: '#1a1a1a', borderColor: '#00ffcc', borderWidth: 1 }, 
                    emphasis: { itemStyle: { areaColor: '#2a2a2a' } } 
                },
                series: [{ 
                    name: 'Puntos', type: 'scatter', coordinateSystem: 'geo', 
                    data: puntosData, 
                    symbol: 'circle', symbolSize: v => Math.max(12, Math.min(60, v[2]*10 + Math.sqrt(v[2])*5)), 
                    label: { show: true, formatter: p => p.data.cantidad > 1 ? p.data.cantidad : '', position: 'inside', color: '#000', fontSize: 12, fontWeight: 'bold' }, 
                    itemStyle: { color: p => p.data.cantidad > 1 ? '#ffaa00' : '#00ffcc', borderColor: '#fff', borderWidth: 2, shadowBlur: 10 }, 
                    emphasis: { itemStyle: { color: p => p.data.cantidad > 1 ? '#ffcc00' : '#00ffff', borderWidth: 4 } } 
                }]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        function generarRanking() {
            const chartDiv = document.getElementById('barChart');
            if (!chartDiv) return;
            let chart = echarts.getInstanceByDom(chartDiv);
            if (chart) echarts.dispose(chart);
            chart = echarts.init(chartDiv);
            
            const datos = window.fichas || [];
            const top10 = [...datos].sort((a, b) => getNum(b, 'ratio') - getNum(a, 'ratio')).slice(0, 10);
            const nombres = top10.map(f => getVal(f, 'nombre') + '\n' + getVal(f, 'pinyin'));
            const likesData = top10.map(f => getNum(f, 'like'));
            const seguidoresData = top10.map(f => getNum(f, 'seguidores'));
            
            const option = {
                backgroundColor: '#1a1a1a',
                title: { text: 'Top 10: Likes vs Seguidores', subtext: 'Cyan = Likes | Naranja = Seguidores', left: 'center', textStyle: { color: '#00ffcc', fontSize: 16 }, subtextStyle: { color: '#888', fontSize: 11 } },
                tooltip: { 
                    trigger: 'axis', axisPointer: { type: 'shadow' }, 
                    formatter: p => { 
                        const f = top10[p[0].dataIndex]; 
                        return '<b>' + getVal(f, 'nombre') + '</b> (' + getVal(f, 'pinyin') + ')<br/>üìç ' + getVal(f, 'origen') + '<br/>‚ù§Ô∏è Likes: <b style="color:#00ffcc">' + getNum(f, 'like') + 'M</b><br/>üë• Seguidores: <b style="color:#ffaa00">' + getNum(f, 'seguidores').toFixed(2) + 'M</b><br/>üìà Ratio: <b style="color:#00ffcc">' + getNum(f, 'ratio').toFixed(2) + '</b>'; 
                    } 
                },
                legend: { data: ['Likes (M)', 'Seguidores (M)'], textStyle: { color: '#fff' }, top: 40 },
                grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true },
                xAxis: { type: 'value', name: 'Millones', axisLine: { lineStyle: { color: '#00ffcc' } }, axisLabel: { color: '#888' }, splitLine: { lineStyle: { color: '#333', type: 'dashed' } } },
                yAxis: { type: 'category', data: nombres, axisLabel: { color: '#fff', fontSize: 11, margin: 15 } },
                series: [
                    { name: 'Likes (M)', type: 'bar', data: likesData, itemStyle: { color: '#00ffcc', borderRadius: [0, 3, 3, 0] }, label: { show: true, position: 'right', color: '#00ffcc', fontSize: 10, formatter: p => p.value + 'M' } },
                    { name: 'Seguidores (M)', type: 'bar', data: seguidoresData, itemStyle: { color: '#ffaa00', borderRadius: [0, 3, 3, 0] }, label: { show: true, position: 'right', color: '#ffaa00', fontSize: 10, formatter: p => p.value.toFixed(2) + 'M' } }
                ]
            };
            chart.setOption(option);
            setTimeout(() => chart.resize(), 100);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            if (sectionId === 'mapa') setTimeout(() => generarMapa(), 200);
            if (sectionId === 'ranking') setTimeout(() => generarRanking(), 200);
            if (sectionId === 'galeria') setTimeout(() => actualizarPagina(), 200);
        }

        function abrirModal(archivo) {
            const img = document.getElementById('modal-img');
            const modal = document.getElementById('modal');
            if (img && modal) {
                img.src = 'https://raw.githubusercontent.com/dicarlophotoart-blip/estudio-douyin-2026/main/cards/' + encodeURIComponent(archivo);
                modal.style.display = 'block';
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function cerrarModal() {
            const modal = document.getElementById('modal');
            if (modal) { 
                modal.style.display = 'none'; 
                modal.classList.remove('active');
                document.body.style.overflow = 'auto'; 
            }
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') cerrarModal(); });
        document.getElementById('modal')?.addEventListener('click', function(e) { if (e.target === this) cerrarModal(); });

        // ‚úÖ INICIO - Esperar datos
        function iniciarApp() {
            if (typeof window.fichas === 'undefined' || !window.fichas || window.fichas.length === 0) {
                console.log('‚è≥ Esperando datos...');
                setTimeout(iniciarApp, 100);
                return;
            }
            
            console.log('‚úÖ Datos cargados:', window.fichas.length, 'creadoras');
            actualizarPagina();
            
            if (typeof echarts !== 'undefined') {
                fetch('china.json')
                    .then(response => { if (!response.ok) throw new Error('HTTP ' + response.status); return response.json(); })
                    .then(chinaJson => {
                        echarts.registerMap('china', chinaJson);
                        console.log('‚úÖ Mapa registrado - Features:', chinaJson.features?.length);
                    })
                    .catch(error => {
                        console.error('‚ùå Error cargando china.json:', error);
                        document.getElementById('chinaMap').innerHTML = '<div style="text-align:center;padding:80px;color:#ffaa00;"><h3>‚ö†Ô∏è Error mapa</h3><p>' + error.message + '</p></div>';
                    });
            }
        }

        document.addEventListener('DOMContentLoaded', iniciarApp);
    </script>
</body>
</html>
