<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Douyin ÊäñÈü≥ - Estudio Etno-Ecol√≥gico 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        header { text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 3px solid #667eea; }
        h1 { color: #667eea; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center; }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }
        .stat-card p { opacity: 0.9; }
        .nav { display: flex; flex-wrap: wrap; gap: 1rem; margin: 2rem 0; justify-content: center; }
        .nav button { padding: 1rem 2rem; border: none; border-radius: 10px; background: #667eea; color: white; cursor: pointer; font-size: 1rem; transition: transform 0.2s; }
        .nav button:hover { transform: translateY(-2px); background: #764ba2; }
        .nav button.active { background: #764ba2; }
        .section { display: none; }
        .section.active { display: block; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .card { background: #f8f9fa; border-radius: 15px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card h3 { color: #667eea; margin-bottom: 0.5rem; }
        .card p { margin: 0.3rem 0; color: #666; }
        .top3-panel { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 15px; color: white; margin: 2rem auto; max-width: 800px; }
        .top3-panel h3 { text-align: center; margin-bottom: 1.5rem; }
        .top3-item { display: flex; align-items: center; margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.15); border-radius: 10px; }
        .medal { font-size: 2.5rem; margin-right: 1rem; width: 50px; text-align: center; }
        .percentage { font-size: 2.5rem; font-weight: bold; color: #FFD700; margin-left: auto; }
        #map-container { width: 100%; height: 600px; margin: 2rem 0; }
        .load-more { text-align: center; margin: 2rem 0; }
        .load-more button { padding: 1rem 3rem; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; }
        footer { text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #eee; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Douyin ÊäñÈü≥</h1>
            <p>ESTUDIO ETNO-ECOL√ìGICO DE NICHOS EN DOUYIN 2026</p>
            <p style="color:#666;margin-top:5px">Juan Carlos Delgado</p>
        </header>

        <!-- PANEL TOP 3 TEM√ÅTICAS -->
        <div class="top3-panel">
            <h3>üèÜ TOP 3 Tem√°ticas - Influencers Famosas</h3>
            <div id="top3-tematicas"></div>
            <small style="display:block;text-align:center;margin-top:1rem;opacity:0.8">* Famosas = +1M seguidores en Douyin</small>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="total-creadoras">0</h3>
                <p>Creadoras</p>
            </div>
            <div class="stat-card">
                <h3 id="max-seguidores">0</h3>
                <p>M√°x seguidores</p>
            </div>
            <div class="stat-card">
                <h3 id="max-ratio">0</h3>
                <p>M√°x ratio</p>
            </div>
            <div class="stat-card">
                <h3 id="total-regiones">0</h3>
                <p>Regiones</p>
            </div>
        </div>

        <div class="nav">
            <button class="active" onclick="showSection('lista')">üìã LISTA</button>
            <button onclick="showSection('galeria')">üñºÔ∏è GALER√çA</button>
            <button onclick="showSection('ranking')">üìä RANKING</button>
            <button onclick="showSection('mapa')">üó∫Ô∏è MAPA</button>
        </div>

        <div id="lista" class="section active">
            <h2>üìã LISTA MAESTRA</h2>
            <p style="color:#666;margin:1rem 0">"Cada creadora es un dato en el ecosistema Douyin"</p>
            <div class="cards-grid" id="cards-container"></div>
            <div class="load-more">
                <button onclick="loadMore()">Cargar m√°s</button>
            </div>
        </div>

        <div id="galeria" class="section">
            <h2>üñºÔ∏è GALER√çA</h2>
            <div class="cards-grid" id="galeria-container"></div>
        </div>

        <div id="ranking" class="section">
            <h2>üìä RANKING</h2>
            <div id="ranking-container"></div>
        </div>

        <div id="mapa" class="section">
            <h2>üó∫Ô∏è MAPA DE DISTRIBUCI√ìN</h2>
            <div id="map-container"></div>
        </div>

        <footer>
            <p>Estudio Etno-Ecol√≥gico de Nichos en Douyin 2026</p>
            <p>Juan Carlos Delgado ¬∑ Marzo 2026</p>
        </footer>
    </div>

    <!-- Scripts: PRIMERO fichas.js (datos), DESPU√âS el resto -->
    <script src="fichas.js"></script>
    <script>
        // ============================================
        // FUNCIONES AUXILIARES - Manejan espacios en propiedades
        // ============================================
        function getProp(card, key) {
            return card[key] || card[key + ' '] || card[key.toLowerCase()] || card[key.toLowerCase() + ' '] || '';
        }
        
        function getNum(card, key) {
            const val = getProp(card, key);
            return typeof val === 'number' ? val : parseFloat(val) || 0;
        }

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let cardsVisibles = 12;
        const cardsPorCarga = 12;
        let mapInstance = null;

        // ============================================
        // ACTUALIZAR P√ÅGINA - Stats principales
        // ============================================
        function actualizarPagina() {
            const cards = window.fichas || [];
            
            document.getElementById('total-creadoras').textContent = cards.length;
            
            const maxSeguidores = cards.reduce((max, c) => {
                const seg = getNum(c, 'seguidores');
                return seg > max ? seg : max;
            }, 0);
            document.getElementById('max-seguidores').textContent = maxSeguidores.toFixed(2) + 'M';
            
            const maxRatio = cards.reduce((max, c) => {
                const ratio = getNum(c, 'ratio');
                return ratio > max ? ratio : max;
            }, 0);
            document.getElementById('max-ratio').textContent = maxRatio.toFixed(2) + '%';
            
            const regiones = new Set(cards.map(c => getProp(c, 'provincia') || 'Sin confirmar'));
            document.getElementById('total-regiones').textContent = regiones.size;
            
            renderCards(cards.slice(0, cardsVisibles));
        }

        // ============================================
        // RENDERIZAR CARDS
        // ============================================
        function renderCards(cards) {
            const container = document.getElementById('cards-container');
            if (!container) return;
            
            container.innerHTML = cards.map(c => `
                <div class="card">
                    <h3>${getProp(c, 'nombre') || 'Sin nombre'}</h3>
                    <p><strong>Pinyin:</strong> ${getProp(c, 'pinyin') || 'N/A'}</p>
                    <p><strong>Seguidores:</strong> ${getNum(c, 'seguidores').toFixed(2)}M</p>
                    <p><strong>Likes:</strong> ${getNum(c, 'like').toFixed(1)}M</p>
                    <p><strong>Ratio:</strong> ${getNum(c, 'ratio').toFixed(2)}%</p>
                    <p><strong>Origen:</strong> ${getProp(c, 'origen') || 'N/A'}</p>
                    <p><strong>Provincia:</strong> ${getProp(c, 'provincia') || 'N/A'}</p>
                    <p><strong>Nicho:</strong> ${getProp(c, 'nicho') || 'N/A'}</p>
                    <p><strong>Tem√°tica:</strong> ${getProp(c, 'tematica_principal') || 'N/A'}</p>
                </div>
            `).join('');
        }

        // ============================================
        // GALER√çA
        // ============================================
        function renderGaleria() {
            const cards = window.fichas || [];
            const container = document.getElementById('galeria-container');
            if (!container) return;
            
            container.innerHTML = cards.map(c => `
                <div class="card">
                    <h3>${getProp(c, 'nombre') || 'Sin nombre'}</h3>
                    <p><strong>Archivo:</strong> ${getProp(c, 'archivo') || 'N/A'}</p>
                    <p><strong>Seguidores:</strong> ${getNum(c, 'seguidores').toFixed(2)}M</p>
                </div>
            `).join('');
        }

        // ============================================
        // RANKING
        // ============================================
        function generarRanking() {
            const cards = window.fichas || [];
            const container = document.getElementById('ranking-container');
            if (!container) return;
            
            const ranking = [...cards].sort((a, b) => getNum(b, 'seguidores') - getNum(a, 'seguidores'));
            
            container.innerHTML = `
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#667eea;color:white;">
                            <th style="padding:1rem;text-align:left;">#</th>
                            <th style="padding:1rem;text-align:left;">Nombre</th>
                            <th style="padding:1rem;text-align:right;">Seguidores</th>
                            <th style="padding:1rem;text-align:right;">Ratio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ranking.map((c, i) => `
                            <tr style="border-bottom:1px solid #eee;">
                                <td style="padding:1rem;">${i + 1}</td>
                                <td style="padding:1rem;">${getProp(c, 'nombre') || 'Sin nombre'}</td>
                                <td style="padding:1rem;text-align:right;">${getNum(c, 'seguidores').toFixed(2)}M</td>
                                <td style="padding:1rem;text-align:right;">${getNum(c, 'ratio').toFixed(2)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ============================================
        // MAPA
        // ============================================
        function generarMapa() {
            const cards = window.fichas || [];
            const container = document.getElementById('map-container');
            if (!container) return;
            
            if (mapInstance) {
                mapInstance.dispose();
            }
            
            mapInstance = echarts.init(container);
            
            const data = cards.map(c => ({
                name: getProp(c, 'nombre') || 'Sin nombre',
                value: [getNum(c, 'coord_x'), getNum(c, 'coord_y'), getNum(c, 'seguidores')]
            })).filter(d => d.value[0] && d.value[1]);
            
            const option = {
                geo: {
                    map: 'china',
                    roam: true,
                    label: { show: true, color: '#333' },
                    itemStyle: {
                        areaColor: '#f0f0f0',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }
                },
                series: [{
                    type: 'scatter',
                    coordinateSystem: 'geo',
                    data: data,
                    symbolSize: 12,
                    itemStyle: { color: '#667eea' },
                    label: { show: true, formatter: '{b}', position: 'right' }
                }]
            };
            
            mapInstance.setOption(option);
        }

        // ============================================
        // TOP 3 TEM√ÅTICAS
        // ============================================
        function calcularTop3Tematicas() {
            const cards = window.fichas || [];
            const famosas = cards.filter(c => getNum(c, 'seguidores') >= 1);
            const conteo = {};
            
            famosas.forEach(c => {
                const t = getProp(c, 'tematica_principal') || 'otras';
                if (!conteo[t]) conteo[t] = { count: 0 };
                conteo[t].count++;
            });
            
            const total = famosas.length;
            if (total === 0) {
                document.getElementById('top3-tematicas').innerHTML = '<p style="text-align:center;padding:2rem">üìä Sin datos suficientes</p>';
                return;
            }
            
            const top3 = Object.entries(conteo)
                .map(([t, d]) => ({ tematica: t, count: d.count, porcentaje: Math.round((d.count / total) * 100) }))
                .sort((a, b) => b.porcentaje - a.porcentaje)
                .slice(0, 3);
            
            const emojis = { danza: 'üíÉ', tradicional: 'üé≠', lifestyle: 'üëó', deportes: 'üèÉ', musica: 'üéµ', arte: 'üé®', otras: '‚≠ê' };
            const medallas = ['ü•á', 'ü•à', 'ü•â'];
            
            let html = '';
            top3.forEach((item, i) => {
                const emoji = emojis[item.tematica] || '‚≠ê';
                html += `
                    <div class="top3-item">
                        <div class="medal">${medallas[i]}</div>
                        <div style="flex:1">
                            <div style="font-size:1.2rem;font-weight:bold;margin-bottom:0.3rem">
                                ${emoji} ${item.tematica.charAt(0).toUpperCase() + item.tematica.slice(1)}
                            </div>
                            <div style="font-size:0.9rem;opacity:0.9">${item.count} de ${total} influencers famosas</div>
                        </div>
                        <div class="percentage">${item.porcentaje}%</div>
                    </div>
                `;
            });
            
            document.getElementById('top3-tematicas').innerHTML = html;
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'mapa') {
                setTimeout(generarMapa, 100);
            }
        }

        function loadMore() {
            cardsVisibles += cardsPorCarga;
            const cards = window.fichas || [];
            renderCards(cards.slice(0, cardsVisibles));
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üöÄ Iniciando aplicaci√≥n...');
                console.log('üìä ECharts cargado:', typeof echarts !== 'undefined');
                
                if (typeof window.fichas !== 'undefined') {
                    actualizarPagina();
                    renderGaleria();
                    generarRanking();
                    calcularTop3Tematicas();
                    console.log('‚úÖ Datos cargados:', window.fichas.length, 'cards');
                } else {
                    console.log('‚ùå fichas.js no carg√≥ o actualizarPagina no existe');
                }
            });
        } else {
            actualizarPagina();
            renderGaleria();
            generarRanking();
            calcularTop3Tematicas();
        }

        setInterval(calcularTop3Tematicas, 30000);
    </script>
</body>
</html>
